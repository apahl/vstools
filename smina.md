# smina

Please see also the excellent blog post [Ligand docking with Smina](https://www.wildcardconsulting.dk/useful-information/ligand-docking-with-smina/) by E.J. Bjerrum

## The Workflow

The full virtual screeening workflow comprises the following steps:

1. Prepare and save the receptor and the reference ligand
1. Save the active site
1. Prepare the screening ligand set
1. Perform the virtual screening on a cluster
1. Analyse the results (on the cluster)
1. Report the results

The steps are described more in detail below.

### Prepare the Receptor and the Reference Ligand

#### Step 1: In PyMOL

This is described nicely in the blog post by E.J: Bjerrum mentioned above.  
The easiest way is to use the PyMOL scripting interface for this.  
First step is to remove waters.  
*Depending on the active site you may decide to keep some waters or even to try different combinations of water in the active site.*  
Then add hydrogens to heteroatoms.  
Make two selections, one for the co-crystallized ligand and one for the receptor.

Save the two selected molecules in individual files.

```
remove resn HOH
h_add elem O or elem N

# create a selection for the ligand
# depending on your receptor file, the names be different
select lig, resn LIG and chain A
select rec, prot_xyz and not lig  # select receptor w/o lig

save rec.pdb, rec
save lig.pdb, lig

```
*The co-crystallized ligand can be used by Smina for the definition of the binding site. When there is no co-crystallized ligand you need to define the binding site manually as box.* 

Smina requires the receptor and the ligand to be in `pdbqt` format. This can be conveniently generated by openbabel.
 
#### Step 2: With OpenBabel

Create the receptor in `pdbqt` format:

    obabel rec.pdb -xr -O rec.pdbqt

Create the reference ligand in `pdbqt` format:

    obabel lig.pdb -O lig.pdbqt -h

### Save the Active Site

For the creation of reports after the analysis of the virtual screen, a PDB file of the active site is needed.  
This is again created in PyMOL:

```
# create a selection for the ligand
select lig, resn LIG and chain A

# select the active site (amino acids up to 6A around the ligand),
# excluding the ligand itself
select as, byres (lig) around 6

# save the active site as `as.pdb`
save as.pdb, as
```
Put this file in the directory where all your analysis dirs end up.

### Prepare Ligand Files

The preparation of the ligands for screening requires several steps.

From the set of ligands we exclude structures with more than 35 heavy atoms and with more than 10 rotatable bonds, as these usually perform bad in the docking anyway.  
Compounds with undefined stereo centers have to be enumerated into the individual stereoisomers, so that a compound with 2 undefined stereo centers is converted into 4 isomeric molecules with the defined stereo centers.  
Then an initial set of 3d coordinates is generated for each ligand.  
Finally, the ligands are saved as individual mol files. To enable parallelization on the cluster, they are saved into numbered subfolders as sets of 100k structures.

We implemented this workflow as a custom Pipeline Pilot script.

For docking, the mol files are converted into `pdbqt` files, again using openbabel in the following script, from single mol files with the Compound_Id as name, distributed over 4 subdirs:

```bash
#!/bin/bash
LSET=3d_vs
mkdir $LSET
cd $LSET
mkdir 1 2 3 4
for SUBDIR in {1..4}; do 
    CTR=0
    cd ../${LSET}_${SUBDIR}_mols  # dir with 100k of mols from PPilot
    for f in *.mol; do 
        bn=$(basename $f .mol)
        obabel $f -O ../$LSET/$SUBDIR/$bn.pdbqt -h > /dev/null 2>&1
        let CTR++
        echo -ne "molecules converted: $CTR\r"
    done
    echo ""
    cd ..
done
```

*Smina can also handle SD files as ligand input format. Please refer to the documentation for how to use these.*

### Perform the Virtual Screening on a Cluster

on an IBM LSF Platform.

#### Script

vs_screen.sh:

```Bash
#!/bin/bash -l
# usage: bsub <bsub options> ./vs_screen.sh <subdir>

# all ligand and receptor files are expected to be in .pdbqt format
REC=clpp
REC_DIR=/scratch/xxx/vs/rec
REF_LIG=$REC_DIR/lig   # reference ligand for autobox (full path without extension)
LIGANDS=3d_vs

NUM_JOBS=200

SUB_DIR=$1  # ligand set subdir
if [[ $SUB_DIR == "" ]]; then
  echo "missing argument: <subdir>"
  exit 1
fi

LIG_DIR=/scratch/xxx/vs/lig
OUT_DIR=/scratch/xxx/vs/out

LFILES=($LIG_DIR/$LIGANDS/$SUB_DIR/lig*.pdbqt)
NUM_LIGS=${#LFILES[@]}
SIZE=$((NUM_LIGS / NUM_JOBS + 1))

mkdir -p $OUT_DIR/$SUB_DIR

# sleep $((LSB_JOBINDEX * 5))
# zero-based indexing!
FIRST=$(((LSB_JOBINDEX - 1) * SIZE))
LAST=$((LSB_JOBINDEX * SIZE - 1))
if [ $LAST -ge $NUM_LIGS ]; then
  LAST=$((NUM_LIGS - 1))
fi

for ((i=FIRST;i<=LAST;i++)); do
  LF=${LFILES[$i]}
  BN=$(basename $LF .pdbqt)
  smina -r $REC_DIR/$REC.pdbqt -l $LF --autobox_add 6 \
        --autobox_ligand $REF_LIG.pdbqt --num_modes 3 \
        --scoring vinardo \
        -o $OUT_DIR/$SUB_DIR/$BN.pdbqt -q --cpu 1 \
        --log $OUT_DIR/$SUB_DIR/$BN.log
done
```

#### Starting the Job

    bsub -J "vsscr[1-200]" -w 'done(xxx)' -W "30:00" -R scratch -o /home/users/xxx/vs/jobout/vsscr_%J-%I.txt -e /home/users/xxx/vs/jobout/vsscr_%J-%I.txt ./vs_screen.sh 1  # ligand set subdir

### Analyse the Results (on the Cluster)

Scanning Smina log files.

This can also be done locally, but for that the complete output from the virtual screen has to be downloaded.  

vs_scan_logs.sh:

```Bash
#!/bin/bash -l
# usage: bsub <bsub options> ./vs_scan_logs.sh

RES_DIR="vs_clpp_comas"  # result dir
VS_DIR=/scratch/apahl/vs

cd $VS_DIR
mkdir -p $RES_DIR

for i in out/*; do
  echo $i...
  # collect the 100 best scoring compounds for each ligand heavy atom count
  # from 22 - 35 heavy atoms
  smina_scan_logs --topha 100 --maxha 35 --minha 22 $i $RES_DIR
done
```

#### Starting the Job

    bsub -J "vsscan" -w 'done()' -W "24:00" -R scratch -o /home/users/xxx/vs/jobout/vsscan_%J.txt -e /home/users/xxx/vs/jobout/vsscan_%J.txt ./vs_scan_logs.sh

#### Further Example Uses of `smina_scan_logs`

    smina_scan_logs --highest 45 --maxle "-1.10" --sortby le vs vs_le

    smina_scan_logs --topha 15 --maxha 30 --minha 23 vs vs_ha

### Report the Results

as HTML documents.

Download the output directory and the scores.txt file that were generated by `smina_scan_logs`.  
Copy `scores.txt` into the output directory.  
Cd into that directory.  
Before the reports can be generated, 2D images of the ligands and the ligand / active site binding modes have to be generated.  
Call `smina_preprep` to accomplish that.  
The `scores.txt` can be edited before generating the reports. The title and the text lines before the ligand score data can be changed, this will be reflected in the reports. At the end of each ligand score line, a remark can be entered, separated from the last value in the line by <tab>. These remarks will also be shown in the reports.
For performance reasons, each report file contains a maximum number of 15 ligands. The required number of reports will be automatically generated.
Call `smina_report` to generate the reports.  
The reports are written in the current dir, but can be moved anywhere after the generation, all required data is statically contained in the HTML files.


## Misc Snippets

Distributing files over multiple folders:

    FILES=*.pdbqt; mkdir 1 2 3; i=0; for f in $FILES; do d=$(printf %d $((1+i/100000))); mv $f $d; let i++; done

Copy files from a text list of file names

    xargs -a files.txt mv -t ../vs/

